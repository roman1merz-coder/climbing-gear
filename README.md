# üßó climbing-gear.com

AI-powered climbing gear comparison engine ‚Äî shoes, ropes, belay devices, and crashpads.

## Local Development

```bash
npm install
npm run dev
```

## Deploy to Vercel

1. Push this repo to GitHub
2. Go to [vercel.com/new](https://vercel.com/new)
3. Import the GitHub repo
4. Vercel auto-detects Vite ‚Äî just click **Deploy**
5. Done! Your site is live.

## Architecture

- **Frontend:** React 18 + Vite 6 (static SPA), React Router 7
- **Backend:** Supabase (Postgres + RPC functions)
- **Scoring:** Client-side JS mirrors the `search_shoes` SQL RPC
- **Deployment:** Vercel (auto-deploys from `main` on push)
- **Data:** Supabase is the single source of truth; seed JSON files are auto-generated fallback

---

## ‚ö†Ô∏è Data Source Strategy (IMPORTANT ‚Äî Read Before Making Changes)

### Golden Rule

> **Supabase is the single source of truth for all product data.**
> Seed JSON files in `src/` are auto-generated fallback copies.
> When data changes, update Supabase first, then regenerate seed files.

### Data Flow

```
Supabase (PostgreSQL)         ‚Üê CANONICAL source of truth
        ‚îÇ
        ‚îú‚îÄ‚îÄ‚ñ∫ main.jsx fetches on mount (all 4 tables + prices)
        ‚îÇ       ‚îÇ
        ‚îÇ       ‚îú‚îÄ‚îÄ‚ñ∫ mergeDataset(supabaseRows, seedArr, seedMap)
        ‚îÇ       ‚îÇ       ‚Ä¢ Supabase rows win for non-null fields
        ‚îÇ       ‚îÇ       ‚Ä¢ Seed-only items are kept as extras
        ‚îÇ       ‚îÇ       ‚Ä¢ Result: FULL dataset (seed ‚à™ supabase)
        ‚îÇ       ‚îÇ
        ‚îÇ       ‚îî‚îÄ‚îÄ‚ñ∫ Passed to all page components via props
        ‚îÇ
        ‚îî‚îÄ‚îÄ‚ñ∫ src/*_seed_data.json (auto-generated fallback)
                ‚Ä¢ Generated by fetching all rows from Supabase
                ‚Ä¢ Stripped of system columns (id, created_at, updated_at)
                ‚Ä¢ Stripped of generated columns (discount_pct, landing_area, etc.)
                ‚Ä¢ Sorted alphabetically by slug for consistent git diffs
                ‚Ä¢ Used when Supabase is temporarily unreachable
```

### Current Data Counts (Feb 2026)

| File | Contents | Count |
|------|----------|-------|
| `src/seed_data.json` | Climbing shoes | 340 |
| `src/rope_seed_data.json` | Ropes (single, half, twin, static) | 155 |
| `src/belay_seed_data.json` | Belay devices | 49 |
| `src/crashpad_seed_data.json` | Crashpads | 111 |
| `src/quickdraw_seed_data.json` | Quickdraws | 44 |

### Image Strategy

All product images are static JPEGs in `public/images/{category}/{slug}.jpg`. The `image_url` field in Supabase holds the canonical path. All categories use `assignLocalImages()` in `main.jsx` for a consistent fallback chain: DB image_url ‚Üí slug-derived path ‚Üí SVG fallback. All images use `loading="lazy"`. Never use external image URLs ‚Äî always download and store locally.

### Rules for Developers and AI Agents

1. **When adding new products:** Insert into Supabase first (via REST API with service_role key), then regenerate the seed JSON file. Add the product image to `public/images/{category}/{slug}.jpg` and set `image_url` in Supabase. Never edit seed files directly.

2. **When building charts or articles:** Parse the seed JSON to compute real statistics. Never hardcode fabricated data arrays ‚Äî always derive from actual data programmatically.

3. **When checking data integrity:** Supabase is correct. If seed and Supabase differ, regenerate the seed file.

4. **Seed regeneration:** Fetch all rows, strip `id`/`created_at`/`updated_at` + generated columns, sort by slug, write as pretty-printed JSON with 2-space indent.

5. **Rope-specific notes:**
   - UIAA fall tests use different weights: **80kg for single ropes**, **55kg for half/twin ropes**
   - Never mix rope types when computing UIAA fall averages or comparisons
   - Filter by `rope_type === "single"` for any single-rope analysis
   - The `triple_rated` field indicates ropes certified for single + half + twin use

6. **When updating Insights.jsx or GearNews.jsx chart data:** Always verify against the seed files. Add a comment referencing the seed file and the date the data was derived:
   ```js
   // Derived from rope_seed_data.json (141 ropes, 106 singles) ‚Äî 2025-02-13
   const ROPE_DIAMETER = [ ... ];
   ```

### Similar Products Logic

Each detail page shows "Similar" or "You May Also Like" products at the bottom. The matching logic varies by product type:

| Product | Logic | Max shown |
|---------|-------|-----------|
| **Shoes** | Same `skill_level` (any overlap) OR same `downturn` | 4 |
| **Ropes** | Same `rope_type` AND overlapping `best_use_cases` | 3 |
| **Belay devices** | Same `device_type` | 3 |
| **Crashpads** | Same `pad_size_category` OR overlapping `best_use` | 3 |
| **Quickdraws** | Same `gate_type` OR same `use_case` | 3 |

No scoring or ranking is applied ‚Äî the first N matches from the dataset are shown. The current product is always excluded.

### Amazon Search Links

Every product detail page includes an Amazon.de search link (with affiliate tag `climbinggear0e-21`). The search query includes the product type for better results:
- Shoes: `climbing shoe {brand} {model}`
- Ropes: `climbing rope {brand} {model}`
- Belays: `belay device {brand} {model}`
- Crashpads: `crash pad {brand} {model}`
- Quickdraws: `quickdraw {brand} {model}`

When no real retailer price data exists (only Amazon search), the "in stock" status is hidden to avoid misleading users.

### Crashpad Subjective Score Algorithms

The 8 subjective scores for crashpads are calculated algorithmically from objective specs:

| Score | Algorithm basis | Possible values |
|-------|----------------|-----------------|
| `pad_size_category` | Area (L√óW) thresholds + thickness | sit_start, small, medium, large, oversized, slider |
| `impact_protection` | Weighted: thickness 60% + foam layers 20% + area 20% | low, moderate, high, very_high |
| `carry_comfort` | Carry features (straps/belt) minus weight penalty; inflatables & light pads (‚â§3kg) ‚Üí excellent | basic, good, excellent |
| `durability` | Shell denier + bottom coating composite | moderate, high |
| `foam_firmness` | Foam type composition (closed=firm, open=soft, mixed by layers) | soft, moderate, firm |
| `gear_storage` | Fold style + area + carry system; thin pads & inflatables ‚Üí none | none, minimal, moderate, generous |
| `approach_suitability` | Weight class √ó carry system quality matrix | roadside, moderate, long |
| `best_use` | Thickness √ó area thresholds; drop lowball if ‚â•12cm+‚â•1.5m¬≤ | lowball, midrange, highball, traverse |

Full algorithm documentation with formulas and justifications is in `crashpad_verification.xlsx` ‚Üí "Algorithm Documentation" sheet.

### React Key Strategy

The card grid uses `slug` as the React key (not `id`) to ensure stable reconciliation when data transitions from seed ‚Üí Supabase-merged. Using `id` caused orphaned DOM nodes because Supabase IDs differ from seed IDs. The grid container also has a `key={grid-${shoes.length}}` to force a clean remount on data transitions.

StrictMode was removed because React 18's concurrent rendering combined with data-loading state transitions caused orphaned DOM elements that weren't properly cleaned up.

### Supabase

The app connects to Supabase using the anon key (public, read-only).
Supabase is the single source of truth for all product data. Seed files are
auto-generated fallback copies that should always match the database.
